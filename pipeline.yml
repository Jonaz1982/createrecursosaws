name: Setup-TF-Backend-$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: SetupBackend
    displayName: "ğŸš€ Crear Backend Terraform en AWS"
    jobs:
      - job: DeployBackend
        displayName: "ğŸ› ï¸ Crear bucket y tabla para backend remoto"
        steps:
          - task: TerraformInstaller@1
            displayName: "ğŸ“¦ Instalar Terraform"
            inputs:
              terraformVersion: 'latest'

          - task: AWSCLI@1
            displayName: "ğŸ” Configurar AWS CLI"
            inputs:
              awsCredentials: "aws-terraform-prueba-eks"
              regionName: "us-east-1"
              command: "version"

          - script: |
              terraform init
              terraform apply -auto-approve
            workingDirectory: "$(System.DefaultWorkingDirectory)/backend-terraform"
            displayName: "ğŸš€ Crear recursos de backend remoto"